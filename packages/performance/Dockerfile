FROM node:dubnium-alpine as builder
WORKDIR /usr/src/app

# Override the base log level (info).
ENV NPM_CONFIG_LOGLEVEL warn

# Default build env
ENV REACT_APP_API_GATEWAY_URL=https://gateway.opencrvs-staging.jembi.org/
ENV REACT_APP_LOGIN_URL=https://login.opencrvs-staging.jembi.org/
ENV REACT_APP_REGISTER_APP_URL=https://register.opencrvs-staging.jembi.org/
ENV REACT_APP_COUNTRY=bgd
ENV REACT_APP_LANGUAGE=en

# Install all dependencies of the current project (for all local packages so that dependant packages are built and linked)
COPY package.json package.json
COPY packages/performance/package.json packages/performance/package.json
COPY packages/components/package.json packages/components/package.json
# TODO remove the following two once compoennts dependency on gateway is removed
COPY packages/gateway/package.json packages/gateway/package.json
COPY packages/commons/package.json packages/commons/package.json
COPY yarn.lock yarn.lock
RUN yarn install

# Copy all source files into the image (including all packages in the repo)
COPY packages/performance packages/performance
COPY packages/components packages/components
COPY packages/gateway packages/gateway
COPY packages/commons packages/commons

# Build for production.
RUN cd packages/components; yarn build && cd ../performance; yarn build --production

# Add nginx build stage that only copies out the built webapp
FROM nginx
COPY --from=builder /usr/src/app/packages/performance/build /usr/share/nginx/html
